---
import Logo from "./header/Logo.astro";
import NavigationDropdown from "./header/NavigationDropdown.astro";
import MobileDropdown from "./header/MobileDropdown.astro";
import MenuIcon from "./icons/MenuIcon.astro";
import {
  aboutMenuItems,
  servicesMenuItems,
  specialtiesMenuItems,
  clientResourcesMenuItems,
} from "../data/navigationData";
import {
  PHONE_NUMBER,
  PHONE_NUMBER_FORMATTED,
  WIDGET_LINK,
  REFERRAL_LINK,
  SIGN_IN_LINK,
} from "../data/resource";
---

<header
  class="sticky top-0 z-50 w-full bg-indigo-950/95 backdrop-blur-sm border-b border-indigo-900"
>
  <div
    class="max-w-7xl mx-auto px-4 sm:px-6 h-16 sm:h-20 flex items-center justify-between"
  >
    <Logo />

    <!-- Mobile Controls (Call Button + Menu Button) -->
    <div class="md:hidden flex items-center gap-2">
      <!-- Mobile Call Button -->
      <a
        id="floatingCallBtn"
        href={`tel:${PHONE_NUMBER}`}
        data-phone={PHONE_NUMBER_FORMATTED}
        class="bg-amber-500 text-indigo-950 px-4 py-2 rounded-full font-black text-xs hover:bg-amber-400 transition-all shadow-lg flex items-center gap-1"
      >
        &#128222; <span>Call</span>
      </a>

      <!-- Mobile menu button -->
      <button id="mobileMenuBtn" 
      class="text-white p-3 -mr-2 focus:outline-none focus:ring-2 focus:ring-amber-500 rounded-lg transition-colors active:bg-white/10"
      aria-label="Open main menu"
      aria-expanded="false"
      aria-controls="mobile-menu"
      >
        <MenuIcon />
      </button>
    </div>

    <!-- Desktop Navigation -->
    <nav class="hidden md:flex items-center gap-6 lg:gap-10">
      <!-- About Dropdown -->
      <NavigationDropdown
        title="About"
        items={aboutMenuItems}
        sectionLabel="Practice Information"
        baseHref="/about"
      />

      <!-- Services Dropdown -->
      <NavigationDropdown
        title="Services"
        items={servicesMenuItems}
        sectionLabel="Our Services"
        baseHref="/services"
      />

      <!-- Specialties Dropdown -->
      <NavigationDropdown
        title="Specialties"
        items={specialtiesMenuItems}
        sectionLabel="Specialties"
        baseHref="/specialities"
      />

      <!-- Resources Dropdown -->
      <NavigationDropdown
        title="Resources"
        items={clientResourcesMenuItems}
        sectionLabel="Client Resources"
        baseHref="/resources"
      />

      <!-- Referrals Link -->
      <a
        href={REFERRAL_LINK}
        target="_blank"
        class="text-sm font-bold text-indigo-100 hover:text-amber-400 transition-colors duration-200"
        >Referrals</a
      >

      <!-- Client Portal Button -->
      <a
        href={SIGN_IN_LINK}
        target="_blank"
        rel="noopener noreferrer"
        class="hidden md:inline-block bg-amber-500 text-indigo-950 px-6 lg:px-8 py-2 lg:py-3 rounded-full font-black text-xs lg:text-sm hover:bg-amber-400 hover:ring-4 hover:ring-amber-500/30 transition-all shadow-lg shadow-amber-500/20 active:scale-95"
      >
        Client Portal
      </a>

      <!-- Call Button (Desktop Only) -->
      <a
        href={`tel:${PHONE_NUMBER}`}
        class="hidden md:inline-block bg-amber-500 text-indigo-950 px-4 lg:px-8 py-2 lg:py-3 rounded-full font-black text-xs lg:text-sm hover:bg-amber-400 hover:ring-4 hover:ring-amber-500/30 transition-all shadow-lg shadow-amber-500/20 active:scale-95"
      >
        &#128222; <span class="lg:inline">{PHONE_NUMBER_FORMATTED}</span>
      </a>
    </nav>
  </div>

  <div
    id="mobileMenu"
    class="hidden md:hidden bg-indigo-950 border-t border-indigo-900"
  >
    <div class="max-w-7xl mx-auto px-4 py-4">
      <!-- About Dropdown -->
      <MobileDropdown
        id="about"
        title="About"
        items={aboutMenuItems}
        baseHref="/about"
      />

      <!-- Services Dropdown -->
      <MobileDropdown
        id="services"
        title="Services"
        items={servicesMenuItems}
        baseHref="/services"
      />

      <!-- Specialties Dropdown -->
      <MobileDropdown
        id="specialties"
        title="Specialties"
        items={specialtiesMenuItems}
        baseHref="/specialities"
      />

      <!-- Resources Dropdown -->
      <MobileDropdown
        id="resources"
        title="Resources"
        items={clientResourcesMenuItems}
        baseHref="/resources"
      />

      <!-- Referrals Link -->
      <a
        href={REFERRAL_LINK}
        target="_blank"
        class="w-full flex items-center justify-between px-4 py-3 text-sm font-bold text-indigo-100 hover:text-amber-400 transition-colors duration-200"
        >Referrals</a
      >

      <!-- Client Portal Button -->
      <div class="flex flex-col gap-3 mt-6">
        <a
          href={WIDGET_LINK}
          target="_blank"
          rel="noopener noreferrer"
          class="block text-center bg-amber-500 text-indigo-950 px-6 py-3 rounded-full font-black text-sm hover:bg-amber-400 transition-all"
        >
          Client Portal
        </a>

        <!-- Mobile Call Button Slot (button will move here when menu opens) -->
        <div id="mobileCallSlot" class="hidden"></div>
      </div>
    </div>
  </div>
</header>

<script>
  import { PHONE_NUMBER_FORMATTED } from "../data/resource";
  
  // Defer script execution until after page render
  document.addEventListener("DOMContentLoaded", () => {
    // Mobile menu toggle with floating button animation
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileMenu = document.getElementById("mobileMenu");
    const menuIcon = document.getElementById("menuIcon");
    const closeIcon = document.getElementById("closeIcon");
    const floatingCallBtn = document.getElementById("floatingCallBtn");
    const mobileCallSlot = document.getElementById("mobileCallSlot");
    const mobileControlsDiv = floatingCallBtn?.parentElement;

    let isMenuOpen = false;

    mobileMenuBtn?.addEventListener("click", () => {
      isMenuOpen = !isMenuOpen;
      
      mobileMenu?.classList.toggle("hidden");
      menuIcon?.classList.toggle("hidden");
      closeIcon?.classList.toggle("hidden");

      // Move call button between header and menu
      if (floatingCallBtn && mobileCallSlot && mobileControlsDiv) {
        if (isMenuOpen) {
          // Menu opening - move button into menu slot
          floatingCallBtn.classList.remove("px-4", "py-2", "text-xs", "gap-1");
          floatingCallBtn.classList.add("px-6", "py-3", "text-sm", "gap-2", "text-center", "w-full", "justify-center");
          floatingCallBtn.innerHTML = `&#128222; <span>Call ${PHONE_NUMBER_FORMATTED}</span>`;
          mobileCallSlot.classList.remove("hidden");
          mobileCallSlot.appendChild(floatingCallBtn);
        } else {
          // Menu closing - return button to header position
          floatingCallBtn.classList.add("px-4", "py-2", "text-xs", "gap-1");
          floatingCallBtn.classList.remove("px-6", "py-3", "text-sm", "gap-2", "text-center", "w-full", "justify-center");
          floatingCallBtn.innerHTML = `&#128222; <span>Call</span>`;
          mobileCallSlot.classList.add("hidden");
          mobileControlsDiv.prepend(floatingCallBtn);
        }
      }
    });

    // Dropdown toggles
    const dropdowns = [
      { toggle: "aboutToggle", content: "aboutContent", icon: "aboutIcon" },
      {
        toggle: "servicesToggle",
        content: "servicesContent",
        icon: "servicesIcon",
      },
      {
        toggle: "specialtiesToggle",
        content: "specialtiesContent",
        icon: "specialtiesIcon",
      },
      {
        toggle: "resourcesToggle",
        content: "resourcesContent",
        icon: "resourcesIcon",
      },
    ];

    dropdowns.forEach(({ toggle, content, icon }) => {
      const toggleBtn = document.getElementById(toggle);
      const contentDiv = document.getElementById(content);
      const iconSvg = document.getElementById(icon);

      toggleBtn?.addEventListener("click", () => {
        contentDiv?.classList.toggle("hidden");
        iconSvg?.classList.toggle("rotate-180");
      });
    });

    // nested About toggles (one per nested item)
    const nestedToggles = document.querySelectorAll('[id^="aboutNestedToggle-"]');
    nestedToggles.forEach((btn) => {
      const slug = btn.id.replace("aboutNestedToggle-", "");
      const content = document.getElementById(`aboutNestedContent-${slug}`);
      const icon = document.getElementById(`aboutNestedIcon-${slug}`);

      btn.addEventListener("click", () => {
        content?.classList.toggle("hidden");
        icon?.classList.toggle("rotate-180");
      });
    });
  });
</script>
