---
import { chatbotTree } from "../data/chatbot";
import { PHONE_NUMBER } from "../data/resource";
import { Icon } from "astro-icon/components";
---

<button id="bot-trigger" 
  type="button"
  aria-label="Open chat assistant"
  class="fixed bottom-4 right-4 md:bottom-5 md:right-5 w-14 h-14 md:w-16 md:h-16 bg-indigo-400 hover:bg-teal-700 text-white rounded-full shadow-2xl flex items-center justify-center z-60 transition-transform hover:scale-110 touch-manipulation">
  <Icon
    name="mdi:chat-outline"
    class="relative w-6 h-6 md:w-9 md:h-9 object-cover rounded-3xl shadow-2xl"
    />
</button>

<div id="chat-container" 
  class="fixed bottom-20 left-3 right-3 md:bottom-24 md:left-auto md:right-5 md:w-96 md:max-h-125 h-[70vh] md:h-auto bg-white rounded-2xl shadow-2xl hidden flex-col overflow-hidden z-60 animate-slide-up">
  
  <div class="bg-indigo-600 p-4 text-white font-bold flex justify-between items-center">
    <span>Twilight Assistant</span>
    <button id="close-chat" type="button" class="text-2xl leading-none hover:text-indigo-200 transition-colors">Ã—</button>
  </div>
  
  <div id="chat-box" class="h-80 overflow-y-auto p-4 flex flex-col gap-3 bg-slate-50 chat-scrollbar">
  </div>
</div>

<script is:inline define:vars={{ tree: chatbotTree }}>
const chatContainer = document.getElementById('chat-container');
const chatBox = document.getElementById('chat-box');
const botTrigger = document.getElementById('bot-trigger');
const closeChat = document.getElementById('close-chat');
let isChatStarted = false;

function toggleChat() {
  if (!chatContainer) return;
  const isHidden = chatContainer.classList.contains('hidden');
  if (isHidden) {
    chatContainer.classList.remove('hidden');
    chatContainer.classList.add('flex');
    if (!isChatStarted) { 
      renderNode('start'); 
      isChatStarted = true; 
    }
  } else {
    chatContainer.classList.add('hidden');
    chatContainer.classList.remove('flex');
  }
}

if (botTrigger) {
  botTrigger.addEventListener('click', toggleChat);
  botTrigger.addEventListener('touchend', (event) => {
    event.preventDefault();
    toggleChat();
  }, { passive: false });
}

if (closeChat) {
  closeChat.addEventListener('click', toggleChat);
  closeChat.addEventListener('touchend', (event) => {
    event.preventDefault();
    toggleChat();
  }, { passive: false });
}

function renderNode(nodeId) {
  if (!chatBox) return;
  const node = tree[nodeId];
  
  const botMsg = document.createElement('div');
  botMsg.className = "bg-slate-200 text-slate-800 p-3 rounded-2xl rounded-bl-none max-w-[85%] text-sm self-start shadow-sm";
  botMsg.innerText = node.text;
  chatBox.appendChild(botMsg);

  const optionsCont = document.createElement('div');
  optionsCont.className = "flex flex-wrap gap-2 mt-1 mb-4";

  if (node.type === "terminal") {
    const callBtn = document.createElement('button');
    callBtn.className = "w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition-colors shadow-md mt-2";
    callBtn.innerText = `${node.action}`;
    callBtn.onclick = () => {
      if (node.actionType === "link" && node.actionValue) {
        window.location.href = node.actionValue;
        return;
      }

      if (node.actionType === "email" && node.actionValue) {
        window.location.href = `mailto:${node.actionValue}`;
        return;
      }

      const phoneNumber = node.actionValue || PHONE_NUMBER;
      window.location.href = `tel:${phoneNumber}`;
    };
    optionsCont.appendChild(callBtn);
    
    const restart = document.createElement('button');
    restart.className = "w-full text-xs text-slate-400 mt-2 hover:text-indigo-600 underline transition-colors";
    restart.innerText = "Start over";
    restart.onclick = () => { 
      chatBox.innerHTML = ''; 
      renderNode('start'); 
    };
    optionsCont.appendChild(restart);
  } else {
    node.options.forEach(opt => {
      const btn = document.createElement('button');
      btn.className = "border border-indigo-600 text-indigo-600 hover:bg-indigo-600 hover:text-white px-4 py-2 rounded-full text-sm transition-all shadow-sm bg-white";
      btn.innerText = opt.label;
      btn.onclick = () => {
        const userMsg = document.createElement('div');
        userMsg.className = "bg-indigo-600 text-white p-3 rounded-2xl rounded-br-none max-w-[85%] text-sm self-end shadow-md";
        userMsg.innerText = opt.label;
        chatBox.appendChild(userMsg);
        optionsCont.remove();
        setTimeout(() => renderNode(opt.next), 300);
      };
      optionsCont.appendChild(btn);
    });
  }
  chatBox.appendChild(optionsCont);
  chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
}
</script>
